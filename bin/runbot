#!/usr/bin/env python3
# This file is placed in the Public Domain.
# pylint: disable=E1101,E0611,C0115,C0116,C0413,C0411,W0406


"operator bot"


import os
import readline
import sys
import termios
import time


from op import Wd, format, keys

from hdl import Client, Event, docmd, parse, scan
from mod.irc import Config, IRC
from mod.rss import Fetcher
from mod import bsc, dbg, log, tdo, irc, rss


Config.nick = "opbot"
Config.channel = "#opbot"
Config.realname = "operator bot"
Config.username = "opbot"


Wd.workdir = os.path.expanduser("~/.opbot")


scan(bsc)
scan(dbg)
scan(irc)
scan(log)
scan(rss)
scan(tdo)


class CLI(Client):

    @staticmethod
    def raw(txt):
        print(txt)


class Console(CLI):

    @staticmethod
    def announce(txt):
        pass

    @staticmethod
    def handle(event):
        Client.handle(event)
        event.wait()

    def poll(self):
        event = Event()
        event.txt = input("> ")
        event.orig = repr(self)
        return event


def banner(bot, cfg):
    print(
          "OPBOT started at %s %s" % (
                                     time.ctime(time.time()).replace("  ", " "),
                                     format(cfg, "debug,verbose")
                                    )
         )


def wrap(func):
    fds = sys.stdin.fileno()
    gotterm = True
    try:
        old = termios.tcgetattr(fds)
    except termios.error:
        gotterm = False
    readline.redisplay()
    try:
        func()
    except (EOFError, KeyboardInterrupt):
        print("")
    finally:
        if gotterm:
            termios.tcsetattr(fds, termios.TCSADRAIN, old)


def main():
    txt = ' '.join(sys.argv[1:])
    cfg = parse(txt)
    if cfg.txt:
        cli = CLI()
        docmd(cli, cfg.otxt)
    elif "c" in cfg.opts:
        bot = IRC()
        bot.start()
        banner(bot, cfg)
        fetcher = Fetcher()
        fetcher.start()
        csl = Console()
        csl.start()
        csl.forever()


wrap(main)
